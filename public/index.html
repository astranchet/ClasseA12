<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Classe Ã  12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="./favicons/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="./favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="./favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="./favicons/favicon-192x192.png" sizes="192x192">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://unpkg.com/template.data.gouv.fr/dist/style/main.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
  <script src="app.js"></script>
  <script>
    const loginForm = window.localStorage.getItem("session");
    const app = Elm.Main.init({ flags: loginForm });

    // A video was selected in the file input, return its object URL so it can be set as a `src` attribute on a video element
    app.ports.videoSelected.subscribe(function (nodeID) {
      const fileInput = document.getElementById(nodeID);
      if (fileInput === null) {
        console.error("Didn't find a file input with id", nodeID);
        return;
      }
      const file = fileInput.files[0];
      const videoObjectUrl = URL.createObjectURL(file);
      app.ports.videoObjectUrl.send(videoObjectUrl);
    });

    function uuidv4() {
      return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      )
    }

    // A new video record has been created, upload the selected video file as an attachment
    app.ports.submitVideo.subscribe(function ({ nodeID, videoData, login, password }) {
      const fileInput = document.getElementById(nodeID);
      if (fileInput === null) {
        console.error("Didn't find a file input with id", nodeID);
        return;
      }
      const file = fileInput.files[0];
      // Create a multipart form to upload the file.
      let formData = new FormData();
      formData.append('attachment', file);
      formData.append('data', JSON.stringify(videoData));

      const recordID = uuidv4();

      // Yes, it would be way nicer to be able to use the GlobalFetch API. But we wouldn't have any report on the progress. :sadface:
      let xhr = new XMLHttpRequest();
      xhr.open("POST", `https://kinto.agopian.info/v1/buckets/classea12/collections/upcoming/records/${recordID}/attachment`);
      xhr.upload.addEventListener("progress", function (event) {
        if (event.lengthComputable) {
          const percentage = Math.round(event.loaded * 100 / event.total);
          app.ports.progressUpdate.send(percentage);
        }
      }, false);
      xhr.onload = function () {
        app.ports.videoSubmitted.send(this.response);
      }
      xhr.onerror = function (event) {
        console.error("network error", event.target);
        app.ports.videoSubmitted.send(this.response);
      }
      xhr.setRequestHeader("Authorization", "Basic " + btoa(`${login}:${password}`));
      xhr.send(formData);
    });

    // A new url has been loaded using pushstate, we need to tell matomo/piwik (analytics) by firing an event
    app.ports.newURL.subscribe(function (url) {
      window.dispatchEvent(new Event('newURL'));
    });

    app.ports.saveSession.subscribe(sessionData => {
      localStorage.setItem("session", JSON.stringify(sessionData));
    });

    app.ports.logoutSession.subscribe(() => {
      localStorage.removeItem("session");
    });
  </script>

  <!-- Matomo -->
  <script type="text/javascript">
    var _paq = _paq || [];
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function () {
      var u = "//stats.data.gouv.fr/";
      _paq.push(['setTrackerUrl', u + 'piwik.php']);
      _paq.push(['setSiteId', '72']);
      var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
      g.type = 'text/javascript'; g.async = true; g.defer = true; g.src = u + 'piwik.js'; s.parentNode.insertBefore(g, s);
    })();

    window.addEventListener("newURL", function () {
      _paq.push(['setCustomUrl', document.location]);
      _paq.push(['setDocumentTitle', document.title]);
      _paq.push(['trackPageView']);
    });
  </script>
  <!-- End Matomo Code -->
</body>

</html>